# 邮箱验证功能说明

## 功能概述

本系统实现了完整的邮箱验证功能，支持通过邮箱验证码进行用户注册、登录和密码重置。

## 配置说明

### 1. 邮箱配置

在 `application-dev.properties` 中配置邮箱服务：

```properties
#===邮件配置 start===
# 邮件服务器配置
spring.mail.host=smtp.qq.com
spring.mail.port=587
spring.mail.username=3278281361@qq.com
spring.mail.password=your_qq_email_authorization_code
spring.mail.properties.mail.smtp.auth=true
spring.mail.properties.mail.smtp.starttls.enable=true
spring.mail.properties.mail.smtp.starttls.required=true
spring.mail.properties.mail.smtp.ssl.enable=true
spring.mail.properties.mail.smtp.ssl.trust=smtp.qq.com
# 发件人配置
spring.mail.from=3278281361@qq.com
#===邮件配置 end===
```

### 2. QQ邮箱授权码获取

1. 登录QQ邮箱
2. 进入设置 -> 账户
3. 开启SMTP服务
4. 获取授权码（不是QQ密码）
5. 将授权码填入配置文件的 `spring.mail.password` 字段

## 数据库表结构

### email_verification_code 表

```sql
CREATE TABLE `email_verification_code` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `email` varchar(100) NOT NULL COMMENT '邮箱地址',
  `code` varchar(10) NOT NULL COMMENT '验证码',
  `create_time` datetime NOT NULL COMMENT '创建时间',
  `expire_time` datetime NOT NULL COMMENT '过期时间',
  `used` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否已使用：0-未使用，1-已使用',
  `type` varchar(20) NOT NULL COMMENT '验证码类型：REGISTER-注册, RESET_PASSWORD-重置密码, LOGIN-登录',
  PRIMARY KEY (`id`),
  KEY `idx_email_type` (`email`, `type`),
  KEY `idx_create_time` (`create_time`),
  KEY `idx_expire_time` (`expire_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='邮箱验证码表';
```

## API接口

### 1. 发送邮箱验证码

**接口地址：** `POST /api/auth/email/send-code`

**请求参数：**
- `email`: 邮箱地址
- `type`: 验证码类型（REGISTER-注册, RESET_PASSWORD-重置密码, LOGIN-登录）

**响应示例：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": true
}
```

### 2. 邮箱验证码登录

**接口地址：** `POST /api/auth/email/login`

**请求参数：**
- `email`: 邮箱地址
- `code`: 验证码

**响应示例：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiJ9...",
    "user": {
      "id": 1,
      "username": "test@example.com",
      "email": "test@example.com",
      "realName": "测试用户"
    },
    "roles": ["USER"]
  }
}
```

### 3. 验证邮箱验证码

**接口地址：** `POST /api/auth/email/verify`

**请求参数：**
- `email`: 邮箱地址
- `code`: 验证码
- `type`: 验证码类型

**响应示例：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": true
}
```

### 4. 检查邮箱是否已验证

**接口地址：** `GET /api/auth/email/check`

**请求参数：**
- `email`: 邮箱地址

**响应示例：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": true
}
```

## 功能特性

### 1. 验证码管理
- 自动生成6位数字验证码
- 验证码有效期10分钟
- 验证码使用后自动标记为已使用
- 防止重复使用验证码

### 2. 邮件模板
- 支持多种邮件模板（注册、登录、密码重置）
- 邮件内容包含验证码和有效期说明
- 发件人显示为系统名称

### 3. 安全机制
- 验证码过期自动失效
- 定时任务清理过期验证码
- 防止验证码重复使用
- 邮箱地址验证

### 4. 定时清理
- 每天凌晨2点自动清理过期验证码
- 减少数据库存储压力
- 提高系统性能

## 使用流程

### 1. 用户注册流程
1. 用户输入邮箱地址
2. 调用发送验证码接口
3. 用户收到验证码邮件
4. 用户输入验证码进行验证
5. 验证成功后完成注册

### 2. 邮箱登录流程
1. 用户选择邮箱登录
2. 输入邮箱地址
3. 调用发送验证码接口
4. 用户收到验证码邮件
5. 用户输入验证码进行登录
6. 登录成功后返回JWT token

### 3. 密码重置流程
1. 用户选择忘记密码
2. 输入邮箱地址
3. 调用发送验证码接口
4. 用户收到验证码邮件
5. 用户输入验证码验证身份
6. 验证成功后允许重置密码

## 注意事项

1. **QQ邮箱授权码**：必须使用QQ邮箱的授权码，不是QQ密码
2. **验证码有效期**：验证码有效期为10分钟，超时需重新发送
3. **频率限制**：建议对发送验证码接口添加频率限制，防止恶意调用
4. **邮件内容**：邮件内容可以根据实际需求进行定制
5. **错误处理**：系统会对各种异常情况进行处理，返回相应的错误信息

## 扩展功能

1. **邮件模板定制**：可以支持HTML邮件模板，提供更美观的邮件内容
2. **验证码类型扩展**：可以添加更多验证码类型，如邮箱绑定、身份验证等
3. **频率限制**：可以添加发送频率限制，防止恶意调用
4. **邮件队列**：可以使用消息队列处理邮件发送，提高系统性能
5. **多邮箱支持**：可以支持多种邮箱服务商，如163、Gmail等 