# 资源分享功能接口文档

## 概述

资源分享功能允许用户将实验项目资源分享给其他用户，支持多种分享方式和权限控制。系统会自动发送通知给被分享的用户，并支持分享的撤销和权限管理。

## 基础信息

- **基础URL**: `http://localhost:8080/resource-share`
- **数据格式**: JSON
- **字符编码**: UTF-8
- **认证方式**: Bearer Token

## 数据库表结构

### resource_share 表

```sql
CREATE TABLE resource_share (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    resource_id BIGINT NOT NULL COMMENT '资源ID',
    shared_by VARCHAR(50) NOT NULL COMMENT '分享者用户名',
    shared_with VARCHAR(50) COMMENT '被分享者用户名',
    permission VARCHAR(20) DEFAULT 'read' COMMENT '权限级别：read/write/admin',
    status VARCHAR(20) DEFAULT 'active' COMMENT '状态：active/inactive/expired',
    share_link VARCHAR(255) COMMENT '分享链接',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    expires_at DATETIME COMMENT '过期时间',
    INDEX idx_resource_id (resource_id),
    INDEX idx_shared_by (shared_by),
    INDEX idx_shared_with (shared_with),
    INDEX idx_share_link (share_link)
);
```

## 数据模型

### ResourceShare 资源共享对象

```json
{
  "id": 1,
  "resourceId": 13,
  "sharedBy": "teacher1",
  "sharedWith": "student1",
  "permission": "read",
  "status": "active",
  "shareLink": "abc123def456",
  "createTime": "2024-01-01T10:00:00",
  "expireTime": "2024-12-31T23:59:59"
}
```

### 权限级别说明

- `read`: 只读权限，可以查看资源
- `write`: 读写权限，可以查看和编辑资源
- `admin`: 管理员权限，可以查看、编辑和删除资源

### 状态说明

- `active`: 活跃状态，分享有效
- `inactive`: 非活跃状态，分享已撤销
- `expired`: 过期状态，分享链接已过期

## API接口

### 1. 生成分享链接

**接口地址**: `POST /resource-share/generate`

**功能描述**: 为指定资源生成一个分享链接，支持设置过期时间

**请求参数**:
- `resourceId` (Long, 必填): 资源ID
- `expireMinutes` (Long, 可选): 过期时间（分钟），不传则永不过期

**请求示例**:
```bash
curl -X POST "http://localhost:8080/resource-share/generate" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "resourceId=13&expireMinutes=1440"
```

**响应示例**:
```json
{
  "code": 200,
  "message": "生成分享链接成功",
  "data": "abc123def456ghi789",
  "success": true
}
```

### 2. 通过用户名分享资源

**接口地址**: `POST /resource-share/share-by-username`

**功能描述**: 将资源直接分享给指定用户，系统会自动发送通知

**请求参数**:
- `resourceId` (Long, 必填): 资源ID
- `targetUsername` (String, 必填): 目标用户名
- `permission` (String, 可选): 权限级别，默认为"read"

**请求示例**:
```bash
curl -X POST "http://localhost:8080/resource-share/share-by-username" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "resourceId=13&targetUsername=student1&permission=write"
```

**响应示例**:
```json
{
  "code": 200,
  "message": "分享成功",
  "data": true,
  "success": true
}
```

### 3. 查询资源的分享列表

**接口地址**: `GET /resource-share/list`

**功能描述**: 获取指定资源的所有分享记录

**请求参数**:
- `resourceId` (Long, 必填): 资源ID

**请求示例**:
```bash
curl -X GET "http://localhost:8080/resource-share/list?resourceId=13" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**响应示例**:
```json
{
  "code": 200,
  "message": "查询成功",
  "data": [
    {
      "id": 1,
      "resourceId": 13,
      "sharedBy": "teacher1",
      "sharedWith": "student1",
      "permission": "read",
      "status": "active",
      "createTime": "2024-01-01T10:00:00"
    }
  ],
  "success": true
}
```

### 4. 获取我分享的资源列表

**接口地址**: `GET /resource-share/shared-by-me`

**功能描述**: 获取当前用户分享给其他人的所有资源列表

**请求示例**:
```bash
curl -X GET "http://localhost:8080/resource-share/shared-by-me" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**响应示例**:
```json
{
  "code": 200,
  "message": "查询成功",
  "data": [
    {
      "id": 1,
      "resourceId": 13,
      "sharedBy": "teacher1",
      "sharedWith": "student1",
      "permission": "read",
      "status": "active",
      "createTime": "2024-01-01T10:00:00"
    }
  ],
  "success": true
}
```

### 5. 获取分享给我的资源列表

**接口地址**: `GET /resource-share/shared-with-me`

**功能描述**: 获取其他用户分享给当前用户的所有资源列表

**请求示例**:
```bash
curl -X GET "http://localhost:8080/resource-share/shared-with-me" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**响应示例**:
```json
{
  "code": 200,
  "message": "查询成功",
  "data": [
    {
      "id": 2,
      "resourceId": 15,
      "sharedBy": "teacher2",
      "sharedWith": "student1",
      "permission": "write",
      "status": "active",
      "createTime": "2024-01-02T14:30:00"
    }
  ],
  "success": true
}
```

### 6. 检查资源访问权限

**接口地址**: `GET /resource-share/check-access`

**功能描述**: 检查当前用户是否有指定资源的访问权限

**请求参数**:
- `resourceId` (Long, 必填): 资源ID
- `permission` (String, 可选): 需要检查的权限级别，默认为"read"

**请求示例**:
```bash
curl -X GET "http://localhost:8080/resource-share/check-access?resourceId=13&permission=write" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**响应示例**:
```json
{
  "code": 200,
  "message": "查询成功",
  "data": true,
  "success": true
}
```

### 7. 取消分享

**接口地址**: `DELETE /resource-share/cancel`

**功能描述**: 取消指定的分享记录

**请求参数**:
- `id` (Long, 必填): 分享记录ID

**请求示例**:
```bash
curl -X DELETE "http://localhost:8080/resource-share/cancel?id=1" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**响应示例**:
```json
{
  "code": 200,
  "message": "取消分享成功",
  "data": "取消分享成功",
  "success": true
}
```

### 8. 撤销分享

**接口地址**: `POST /resource-share/revoke/{shareId}`

**功能描述**: 撤销指定的分享，将状态设置为inactive

**路径参数**:
- `shareId` (Long, 必填): 分享记录ID

**请求示例**:
```bash
curl -X POST "http://localhost:8080/resource-share/revoke/1" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**响应示例**:
```json
{
  "code": 200,
  "message": "撤销分享成功",
  "data": true,
  "success": true
}
```

### 9. 更新分享权限

**接口地址**: `PUT /resource-share/update-permission/{shareId}`

**功能描述**: 更新指定分享的权限级别

**路径参数**:
- `shareId` (Long, 必填): 分享记录ID

**请求参数**:
- `permission` (String, 必填): 新的权限级别

**请求示例**:
```bash
curl -X PUT "http://localhost:8080/resource-share/update-permission/1" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "permission=write"
```

**响应示例**:
```json
{
  "code": 200,
  "message": "更新权限成功",
  "data": true,
  "success": true
}
```

## 通知功能

系统会在以下情况下自动发送通知：

### 1. 资源分享通知
- **触发条件**: 用户通过用户名分享资源时
- **通知类型**: `RESOURCE_SHARED`
- **通知内容**: "用户 {分享者} 向您分享了资源【{资源名称}】"

### 2. 分享撤销通知
- **触发条件**: 用户撤销分享时
- **通知类型**: `RESOURCE_SHARE_REVOKED`
- **通知内容**: "用户 {分享者} 撤销了与您分享的资源【{资源名称}】"

### 3. 权限更新通知
- **触发条件**: 用户更新分享权限时
- **通知类型**: `RESOURCE_SHARE_PERMISSION_UPDATED`
- **通知内容**: "用户 {分享者} 更新了与您分享的资源【{资源名称}】的权限为：{权限级别}"

## 错误处理

### 常见错误码

| 错误码 | 说明 |
|--------|------|
| 400 | 请求参数错误 |
| 401 | 未授权访问 |
| 403 | 权限不足 |
| 404 | 资源不存在 |
| 409 | 资源已分享给该用户 |
| 500 | 服务器内部错误 |

### 错误响应示例

```json
{
  "code": 400,
  "message": "资源不存在",
  "data": null,
  "success": false
}
```

## 权限控制

### 分享权限检查
- 只有资源的上传者才能分享该资源
- 不能重复分享给同一用户
- 分享者可以随时撤销或修改分享权限

### 访问权限检查
- 资源所有者拥有所有权限
- 被分享用户根据分享权限级别获得相应权限
- 权限级别：admin > write > read

## 使用示例

### 完整分享流程

1. **分享资源给用户**
```bash
curl -X POST "http://localhost:8080/resource-share/share-by-username" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d "resourceId=13&targetUsername=student1&permission=write"
```

2. **检查访问权限**
```bash
curl -X GET "http://localhost:8080/resource-share/check-access?resourceId=13&permission=write" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

3. **查看分享列表**
```bash
curl -X GET "http://localhost:8080/resource-share/shared-with-me" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

4. **更新分享权限**
```bash
curl -X PUT "http://localhost:8080/resource-share/update-permission/1" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d "permission=admin"
```

5. **撤销分享**
```bash
curl -X POST "http://localhost:8080/resource-share/revoke/1" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## 注意事项

1. 所有接口都需要有效的JWT Token认证
2. 分享者必须是资源的上传者
3. 不能重复分享给同一用户
4. 系统会自动发送通知给被分享的用户
5. 分享权限的继承关系：admin包含write权限，write包含read权限
6. 撤销分享后，被分享用户将无法访问该资源
7. 分享链接支持设置过期时间，过期后自动失效 