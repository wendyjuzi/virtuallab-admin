<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.edu.virtuallab.resource.dao.ResourceShareDao">

    <insert id="insert" parameterType="com.edu.virtuallab.resource.model.ResourceShare">
        INSERT INTO resource_share (resource_id, shared_by, shared_with, share_type, permission, status,
                                   created_at, updated_at, expires_at, share_link, share_code, share_title,
                                   share_description, share_image, view_count, download_count)
        VALUES (#{resourceId}, #{sharedBy}, #{sharedWith}, #{shareType}, #{permission}, #{status},
                #{createdAt}, #{updatedAt}, #{expiresAt}, #{shareLink}, #{shareCode}, #{shareTitle},
                #{shareDescription}, #{shareImage}, #{viewCount}, #{downloadCount})
    </insert>

    <update id="update" parameterType="com.edu.virtuallab.resource.model.ResourceShare">
        UPDATE resource_share
        SET shared_by = #{sharedBy},
            shared_with = #{sharedWith},
            share_type = #{shareType},
            permission = #{permission},
            status = #{status},
            updated_at = #{updatedAt},
            expires_at = #{expiresAt},
            share_link = #{shareLink},
            share_code = #{shareCode},
            share_title = #{shareTitle},
            share_description = #{shareDescription},
            share_image = #{shareImage},
            view_count = #{viewCount},
            download_count = #{downloadCount}
        WHERE id = #{id}
    </update>

    <delete id="delete" parameterType="long">
        DELETE FROM resource_share WHERE id = #{id}
    </delete>

    <select id="selectById" parameterType="long" resultType="com.edu.virtuallab.resource.model.ResourceShare">
        SELECT * FROM resource_share WHERE id = #{id}
    </select>

    <select id="selectByResourceId" parameterType="long" resultType="com.edu.virtuallab.resource.model.ResourceShare">
        SELECT * FROM resource_share WHERE resource_id = #{resourceId} ORDER BY created_at DESC
    </select>

    <select id="selectBySharedWith" parameterType="string" resultType="com.edu.virtuallab.resource.model.ResourceShare">
        SELECT * FROM resource_share WHERE shared_with = #{sharedWith} ORDER BY created_at DESC
    </select>

    <select id="selectBySharedBy" parameterType="string" resultType="com.edu.virtuallab.resource.model.ResourceShare">
        SELECT * FROM resource_share WHERE shared_by = #{sharedBy} ORDER BY created_at DESC
    </select>

    <select id="selectByResourceAndUser" resultType="com.edu.virtuallab.resource.model.ResourceShare">
        SELECT * FROM resource_share WHERE resource_id = #{resourceId} AND shared_with = #{sharedWith} LIMIT 1
    </select>

    <select id="selectByShareLink" parameterType="string" resultType="com.edu.virtuallab.resource.model.ResourceShare">
        SELECT * FROM resource_share WHERE share_link = #{shareLink} AND status = 'active' LIMIT 1
    </select>

    <select id="selectByShareCode" parameterType="string" resultType="com.edu.virtuallab.resource.model.ResourceShare">
        SELECT * FROM resource_share WHERE share_code = #{shareCode} AND status = 'active' LIMIT 1
    </select>

    <select id="selectByShareType" parameterType="string" resultType="com.edu.virtuallab.resource.model.ResourceShare">
        SELECT * FROM resource_share WHERE share_type = #{shareType} ORDER BY created_at DESC
    </select>

    <select id="selectByClassId" parameterType="string" resultType="com.edu.virtuallab.resource.model.ResourceShare">
        SELECT * FROM resource_share WHERE shared_with = #{classId} AND share_type = 'class' ORDER BY created_at DESC
    </select>

    <select id="selectByUserId" parameterType="string" resultType="com.edu.virtuallab.resource.model.ResourceShare">
        SELECT * FROM resource_share WHERE shared_with = #{userId} AND share_type = 'user' ORDER BY created_at DESC
    </select>

    <select id="selectExpiredShares" resultType="com.edu.virtuallab.resource.model.ResourceShare">
        SELECT
        id, share_code, resource_id, user_id,
        expires_at, status, create_time, update_time
        FROM resource_share
        WHERE
        expires_at &lt;#{currentTime}
        AND status = #{status}
        ORDER BY expires_at ASC
        <if test="pageSize != null and pageSize > 0">
            LIMIT #{pageSize} OFFSET #{pageNum}
        </if>
    </select>

    <update id="updateViewCount" parameterType="long">
        UPDATE resource_share SET view_count = view_count + 1 WHERE id = #{id}
    </update>

    <update id="updateDownloadCount" parameterType="long">
        UPDATE resource_share SET download_count = download_count + 1 WHERE id = #{id}
    </update>

    <update id="updateStatus">
        UPDATE resource_share SET status = #{status}, updated_at = NOW() WHERE id = #{id}
    </update>

    <!-- 统计方法 -->
    <select id="countByResourceId" parameterType="long" resultType="int">
        SELECT COUNT(*) FROM resource_share WHERE resource_id = #{resourceId}
    </select>

    <select id="countBySharedBy" parameterType="string" resultType="int">
        SELECT COUNT(*) FROM resource_share WHERE shared_by = #{sharedBy}
    </select>

    <select id="countBySharedWith" parameterType="string" resultType="int">
        SELECT COUNT(*) FROM resource_share WHERE shared_with = #{sharedWith}
    </select>

    <select id="countByShareType" parameterType="string" resultType="int">
        SELECT COUNT(*) FROM resource_share WHERE share_type = #{shareType}
    </select>

</mapper>