# 权限管理系统业务逻辑说明

## 概述

本系统实现了完整的权限管理功能，包括系统管理员和院系管理员两个层级的权限管理。系统采用基于角色的访问控制（RBAC）模型，支持细粒度的权限控制和灵活的权限分配。

## 系统架构

### 1. 权限层级结构
```
系统管理员 (System Admin)
├── 全局权限管理
├── 院系管理员管理
├── 系统监控与审计
└── 院系管理

院系管理员 (Department Admin)
├── 本院系用户管理
├── 本院系权限管理
├── 教学资源管理
└── 与系统管理员协同
```

### 2. 角色定义
- **系统管理员 (SYSTEM_ADMIN)**: 拥有系统最高权限
- **院系管理员 (DEPARTMENT_ADMIN)**: 管理本院系用户和权限
- **教师 (TEACHER)**: 教学相关权限
- **学生 (STUDENT)**: 学习相关权限
- **访客 (VISITOR)**: 基础访问权限

## 系统管理员业务逻辑

### 1. 账号全生命周期管理

#### 1.1 用户创建
```java
// 创建单个用户
UserCreateDTO userDTO = new UserCreateDTO();
userDTO.setUsername("teacher001");
userDTO.setPassword("123456");
userDTO.setRealName("张老师");
userDTO.setDepartment("计算机学院");
userDTO.setDepartmentId(1L);
userDTO.setUserType("TEACHER");
userDTO.setRoleIds(Arrays.asList(3L)); // 教师角色ID

User user = systemAdminService.createUser(userDTO);
```

#### 1.2 批量用户管理
```java
// 批量创建用户
List<UserCreateDTO> userDTOs = Arrays.asList(userDTO1, userDTO2, userDTO3);
List<User> users = systemAdminService.batchCreateUsers(userDTOs);

// 批量操作支持事务回滚，单个用户失败不影响其他用户
```

#### 1.3 用户状态管理
```java
// 停用用户
systemAdminService.disableUser(userId, "离职");

// 启用用户
systemAdminService.enableUser(userId);

// 锁定用户
systemAdminService.lockUser(userId, "异常登录");

// 解锁用户
systemAdminService.unlockUser(userId);

// 重置密码
systemAdminService.resetUserPassword(userId, "newPassword123");
```

### 2. 角色权限全局管理

#### 2.1 角色管理
```java
// 创建角色
Role role = new Role();
role.setName("实验管理员");
role.setCode("EXPERIMENT_ADMIN");
role.setDescription("负责实验项目管理");
systemAdminService.createRole(role);

// 更新角色
role.setDescription("负责实验项目和资源管理");
systemAdminService.updateRole(role);

// 删除角色（检查依赖关系）
systemAdminService.deleteRole(roleId);
```

#### 2.2 权限分配
```java
// 为角色分配权限
List<Long> permissionIds = Arrays.asList(1L, 2L, 3L);
systemAdminService.assignPermissionsToRole(roleId, permissionIds);

// 为用户分配角色
List<Long> roleIds = Arrays.asList(3L, 4L);
systemAdminService.assignRolesToUser(userId, roleIds);
```

#### 2.3 权限模板管理
```java
// 创建权限模板
PermissionTemplateDTO template = new PermissionTemplateDTO();
template.setName("教师标准权限");
template.setDescription("教师基础权限模板");
template.setPermissionIds(Arrays.asList(1L, 2L, 3L));
systemAdminService.createPermissionTemplate(template);

// 应用权限模板
systemAdminService.applyPermissionTemplate(templateId, roleId);
```

#### 2.4 临时权限管理
```java
// 设置临时权限
String startTime = "2024-01-01 00:00:00";
String endTime = "2024-12-31 23:59:59";
systemAdminService.setTemporaryPermission(userId, roleId, startTime, endTime, "临时项目需要");

// 回收临时权限
systemAdminService.revokeTemporaryPermission(userRoleId);
```

### 3. 院系管理员管理

#### 3.1 创建院系管理员
```java
// 创建院系管理员
UserCreateDTO adminDTO = new UserCreateDTO();
adminDTO.setUsername("dept_admin");
adminDTO.setPassword("123456");
adminDTO.setRealName("李主任");
adminDTO.setDepartment("计算机学院");
adminDTO.setDepartmentId(1L);
adminDTO.setUserType("DEPARTMENT_ADMIN");

User admin = systemAdminService.createDepartmentAdmin(adminDTO);
```

#### 3.2 院系管理员权限管理
```java
// 为院系管理员分配权限
List<Long> permissionIds = Arrays.asList(10L, 11L, 12L);
systemAdminService.assignDepartmentAdminPermissions(userId, departmentId, permissionIds);

// 调整院系管理员权限
systemAdminService.adjustDepartmentAdminPermissions(userId, permissionIds);
```

### 4. 院系管理

#### 4.1 院系CRUD操作
```java
// 创建院系
Department dept = new Department();
dept.setName("人工智能学院");
dept.setCode("AI");
dept.setDescription("人工智能相关专业");
dept.setLevel(Department.LEVEL_COLLEGE);
systemAdminService.createDepartment(dept);

// 更新院系
dept.setDescription("人工智能与机器学习相关专业");
systemAdminService.updateDepartment(dept);

// 删除院系（检查是否有用户）
systemAdminService.deleteDepartment(deptId);
```

### 5. 系统监控与审计

#### 5.1 操作日志管理
```java
// 查询操作日志
PageResult<OperationLog> logs = systemAdminService.getOperationLogs(
    "teacher001", "CREATE", "USER", "2024-01-01", "2024-12-31", 1, 10
);

// 导出操作日志
String exportFile = systemAdminService.exportOperationLogs(
    "teacher001", "CREATE", "USER", "2024-01-01", "2024-12-31"
);
```

#### 5.2 统计分析
```java
// 用户登录统计
List<Object> loginStats = systemAdminService.getUserLoginStatistics("2024-01-01", "2024-12-31");

// 权限使用统计
List<Object> permissionStats = systemAdminService.getPermissionUsageStatistics("2024-01-01", "2024-12-31");

// 生成安全审计报告
String auditReport = systemAdminService.generateSecurityAuditReport("2024-01-01", "2024-12-31");
```

## 院系管理员业务逻辑

### 1. 本院系账号管理

#### 1.1 用户创建与管理
```java
// 创建本院系用户
UserCreateDTO userDTO = new UserCreateDTO();
userDTO.setUsername("student001");
userDTO.setPassword("123456");
userDTO.setRealName("王同学");
userDTO.setDepartment("计算机学院");
userDTO.setDepartmentId(1L);
userDTO.setUserType("STUDENT");
userDTO.setRoleIds(Arrays.asList(4L)); // 学生角色ID

User user = departmentAdminService.createDepartmentUser(userDTO, adminUserId);

// 批量创建用户
List<UserCreateDTO> userDTOs = Arrays.asList(userDTO1, userDTO2, userDTO3);
List<User> users = departmentAdminService.batchCreateDepartmentUsers(userDTOs, adminUserId);
```

#### 1.2 用户状态管理
```java
// 停用用户
departmentAdminService.disableDepartmentUser(userId, "休学", adminUserId);

// 启用用户
departmentAdminService.enableDepartmentUser(userId, adminUserId);

// 锁定用户
departmentAdminService.lockDepartmentUser(userId, "异常登录", adminUserId);

// 解锁用户
departmentAdminService.unlockDepartmentUser(userId, adminUserId);

// 重置密码
departmentAdminService.resetDepartmentUserPassword(userId, "newPassword123", adminUserId);
```

### 2. 本院系权限管理

#### 2.1 角色分配
```java
// 为用户分配角色
List<Long> roleIds = Arrays.asList(3L, 4L); // 教师角色、实验管理员角色
departmentAdminService.assignRolesToDepartmentUser(userId, roleIds, adminUserId);

// 移除用户角色
List<Long> roleIdsToRemove = Arrays.asList(4L);
departmentAdminService.removeDepartmentUserRoles(userId, roleIdsToRemove, adminUserId);
```

#### 2.2 临时权限管理
```java
// 设置临时权限
String startTime = "2024-01-01 00:00:00";
String endTime = "2024-12-31 23:59:59";
departmentAdminService.setDepartmentUserTemporaryPermission(
    userId, roleId, startTime, endTime, "临时项目需要", adminUserId
);

// 回收临时权限
departmentAdminService.revokeDepartmentUserTemporaryPermission(userRoleId, adminUserId);
```

#### 2.3 权限调整
```java
// 调整用户权限（在系统管理员设定的模板基础上微调）
List<Long> permissionIds = Arrays.asList(10L, 11L);
departmentAdminService.adjustDepartmentUserPermissions(userId, permissionIds, adminUserId);
```

### 3. 教学资源与数据管理

#### 3.1 资源管理
```java
// 管理本院系教学资源
departmentAdminService.manageDepartmentResource(resourceId, "APPROVE", adminUserId);

// 审核教师提交的资源
departmentAdminService.approveDepartmentResource(resourceId, "APPROVED", "资源质量良好", adminUserId);
```

#### 3.2 成绩管理
```java
// 管理本院系学生成绩数据
departmentAdminService.manageDepartmentScore(scoreId, "UPDATE", adminUserId);

// 生成本院系成绩报表
String report = departmentAdminService.generateDepartmentScoreReport(adminUserId);
```

### 4. 与系统管理员协同

#### 4.1 权限申请
```java
// 提交权限申请
List<Long> userIds = Arrays.asList(1L, 2L, 3L);
List<Long> permissionIds = Arrays.asList(10L, 11L);
departmentAdminService.submitPermissionRequest(
    "BATCH_PERMISSION", "为实验项目组分配特殊权限", userIds, permissionIds, adminUserId
);

// 获取权限申请状态
List<Object> requestStatus = departmentAdminService.getPermissionRequestStatus(adminUserId);
```

#### 4.2 异常上报
```java
// 上报账号异常
departmentAdminService.reportUserAbnormal(
    userId, "LOGIN_ABNORMAL", "用户登录IP异常", adminUserId
);
```

### 5. 查询功能

#### 5.1 用户查询
```java
// 分页查询本院系用户
PageResult<User> userPage = departmentAdminService.getDepartmentUserList(
    "teacher", "张", "TEACHER", 1, adminUserId, 1, 10
);

// 获取用户角色
List<Role> userRoles = departmentAdminService.getDepartmentUserRoles(userId, adminUserId);
```

#### 5.2 权限查询
```java
// 获取本院系可分配的角色
List<Role> assignableRoles = departmentAdminService.getDepartmentAssignableRoles(adminUserId);

// 获取本院系可分配的权限
List<Permission> assignablePermissions = departmentAdminService.getDepartmentAssignablePermissions(adminUserId);
```

#### 5.3 操作日志查询
```java
// 查询本院系操作日志
PageResult<OperationLog> logs = departmentAdminService.getDepartmentOperationLogs(
    "teacher001", "CREATE", "USER", "2024-01-01", "2024-12-31", adminUserId, 1, 10
);
```

#### 5.4 统计分析
```java
// 获取本院系用户统计
Object userStats = departmentAdminService.getDepartmentUserStatistics(adminUserId);

// 获取本院系权限使用统计
Object permissionStats = departmentAdminService.getDepartmentPermissionUsageStatistics(adminUserId);
```

## 权限控制机制

### 1. 院系隔离
- 院系管理员只能管理自己所属院系的用户
- 无法查看或操作其他院系的用户数据
- 所有操作都会验证用户所属院系

### 2. 角色权限
- 系统管理员可以创建、修改、删除所有角色和权限
- 院系管理员只能为本院系用户分配系统预设的角色
- 院系管理员可以设置临时权限，但需要指定有效期

### 3. 操作审计
- 所有关键操作都会记录操作日志
- 支持操作日志的查询、导出和统计分析
- 提供安全审计报告生成功能

## 异常处理

### 1. 业务异常
- **权限不足异常**: 尝试操作超出权限范围时抛出
- **用户不存在异常**: 操作的用户ID不存在时抛出
- **角色不存在异常**: 分配的角色ID不存在时抛出
- **院系不匹配异常**: 院系管理员操作其他院系用户时抛出

### 2. 事务处理
- 批量操作支持事务回滚
- 单个操作失败不影响其他操作
- 提供详细的操作日志记录

## 扩展功能

### 1. 权限模板
- 支持创建权限模板，快速分配权限
- 模板可以复用，提高权限管理效率

### 2. 临时权限
- 支持设置临时权限，自动过期
- 适用于临时项目或特殊需求

### 3. 统计分析
- 提供用户登录统计
- 提供权限使用统计
- 支持生成安全审计报告

### 4. 协同工作
- 院系管理员可以向系统管理员申请权限
- 支持异常情况的上报和处理
- 提供权限申请状态跟踪

## 总结

本权限管理系统实现了完整的RBAC权限控制，支持系统管理员和院系管理员两个层级的权限管理。系统具有良好的扩展性和可维护性，能够满足教育机构复杂的权限管理需求。 