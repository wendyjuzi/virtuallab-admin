# 邮箱验证功能测试指南

## 功能概述

本系统实现了完整的邮箱验证功能，包括：
- 发送邮箱验证码
- 验证邮箱验证码
- 邮箱验证码登录
- 自动清理过期验证码

## 数据库配置

### 1. 创建数据库表

确保已执行以下SQL脚本创建邮箱验证码表：

```sql
-- 邮箱验证码表
CREATE TABLE IF NOT EXISTS `email_verification_code` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `email` varchar(100) NOT NULL COMMENT '邮箱地址',
  `code` varchar(10) NOT NULL COMMENT '验证码',
  `create_time` datetime NOT NULL COMMENT '创建时间',
  `expire_time` datetime NOT NULL COMMENT '过期时间',
  `used` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否已使用：0-未使用，1-已使用',
  `type` varchar(20) NOT NULL COMMENT '验证码类型：REGISTER-注册, RESET_PASSWORD-重置密码, LOGIN-登录',
  PRIMARY KEY (`id`),
  KEY `idx_email_type` (`email`, `type`),
  KEY `idx_create_time` (`create_time`),
  KEY `idx_expire_time` (`expire_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='邮箱验证码表';
```

### 2. 检查表结构

```sql
-- 查看表结构
DESCRIBE email_verification_code;

-- 查看索引
SHOW INDEX FROM email_verification_code;
```

## API接口测试

### 1. 测试基础连接

**接口**: `GET /auth/factor/test`

**测试命令**:
```bash
curl -X GET "http://localhost:8080/auth/factor/test"
```

**预期响应**:
```json
{
  "code": 200,
  "message": "操作成功",
  "data": "API服务正常运行"
}
```

### 2. 发送邮箱验证码

**接口**: `POST /api/auth/email/send-code`

**测试命令**:
```bash
# 发送登录验证码
curl -X POST "http://localhost:8080/api/auth/email/send-code" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "email=test@example.com&type=LOGIN"

# 发送注册验证码
curl -X POST "http://localhost:8080/api/auth/email/send-code" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "email=test@example.com&type=REGISTER"
```

**预期响应**:
```json
{
  "code": 200,
  "message": "操作成功",
  "data": true
}
```

### 3. 验证邮箱验证码

**接口**: `POST /api/auth/email/verify`

**测试命令**:
```bash
curl -X POST "http://localhost:8080/api/auth/email/verify" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "email=test@example.com&code=123456&type=LOGIN"
```

**预期响应**:
```json
{
  "code": 200,
  "message": "操作成功",
  "data": true
}
```

### 4. 邮箱验证码登录

**接口**: `POST /api/auth/email/login`

**测试命令**:
```bash
curl -X POST "http://localhost:8080/api/auth/email/login" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "email=test@example.com&code=123456"
```

**预期响应**:
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiJ9...",
    "user": {
      "id": 1,
      "username": "test@example.com",
      "email": "test@example.com"
    },
    "roles": ["USER"]
  }
}
```

## 数据库验证

### 1. 检查验证码记录

```sql
-- 查看所有验证码记录
SELECT * FROM email_verification_code ORDER BY create_time DESC;

-- 查看特定邮箱的验证码
SELECT * FROM email_verification_code 
WHERE email = 'test@example.com' 
ORDER BY create_time DESC;

-- 查看未使用的验证码
SELECT * FROM email_verification_code 
WHERE used = 0 AND expire_time > NOW()
ORDER BY create_time DESC;
```

### 2. 手动插入测试数据

```sql
-- 插入测试验证码
INSERT INTO email_verification_code (email, code, create_time, expire_time, used, type) 
VALUES ('test@example.com', '123456', NOW(), DATE_ADD(NOW(), INTERVAL 10 MINUTE), 0, 'LOGIN');
```

### 3. 清理过期验证码

```sql
-- 手动清理过期验证码
DELETE FROM email_verification_code WHERE expire_time < NOW();

-- 查看清理结果
SELECT COUNT(*) as expired_count FROM email_verification_code WHERE expire_time < NOW();
```

## 前端测试代码

### JavaScript测试

```javascript
// 测试发送邮箱验证码
async function testSendEmailCode() {
  try {
    const formData = new FormData();
    formData.append('email', 'test@example.com');
    formData.append('type', 'LOGIN');
    
    const response = await fetch('/api/auth/email/send-code', {
      method: 'POST',
      body: formData
    });
    
    const data = await response.json();
    console.log('发送结果:', data);
    
    if (data.code === 200) {
      console.log('✅ 验证码发送成功');
    } else {
      console.log('❌ 验证码发送失败:', data.message);
    }
  } catch (error) {
    console.error('❌ 请求失败:', error);
  }
}

// 测试验证邮箱验证码
async function testVerifyEmailCode() {
  try {
    const formData = new FormData();
    formData.append('email', 'test@example.com');
    formData.append('code', '123456');
    formData.append('type', 'LOGIN');
    
    const response = await fetch('/api/auth/email/verify', {
      method: 'POST',
      body: formData
    });
    
    const data = await response.json();
    console.log('验证结果:', data);
    
    if (data.code === 200) {
      console.log('✅ 验证码验证成功');
    } else {
      console.log('❌ 验证码验证失败:', data.message);
    }
  } catch (error) {
    console.error('❌ 请求失败:', error);
  }
}

// 执行测试
testSendEmailCode();
setTimeout(testVerifyEmailCode, 2000); // 2秒后测试验证
```

## 常见问题排查

### 1. 邮件发送失败

**检查项**:
- 邮箱配置是否正确（参考QQ邮箱配置指南）
- 网络连接是否正常
- 防火墙是否阻止SMTP连接

**日志查看**:
```bash
# 查看应用日志
tail -f logs/application.log

# 查看错误日志
grep "ERROR" logs/application.log
```

### 2. 验证码验证失败

**检查项**:
- 验证码是否过期
- 验证码是否已使用
- 邮箱地址是否匹配

**数据库查询**:
```sql
-- 检查验证码状态
SELECT * FROM email_verification_code 
WHERE email = 'test@example.com' 
AND code = '123456' 
AND type = 'LOGIN'
ORDER BY create_time DESC;
```

### 3. 数据库连接问题

**检查项**:
- 数据库服务是否启动
- 连接配置是否正确
- 表是否存在

**测试命令**:
```bash
# 测试数据库连接
mysql -h localhost -u root -p virtuallab -e "SELECT 1;"

# 检查表是否存在
mysql -h localhost -u root -p virtuallab -e "SHOW TABLES LIKE 'email_verification_code';"
```

## 性能测试

### 1. 并发测试

```bash
# 使用ab工具进行并发测试
ab -n 100 -c 10 -p post_data.txt -T application/x-www-form-urlencoded http://localhost:8080/api/auth/email/send-code
```

### 2. 数据库性能

```sql
-- 检查索引使用情况
EXPLAIN SELECT * FROM email_verification_code WHERE email = 'test@example.com' AND type = 'LOGIN';

-- 查看表大小
SELECT 
    table_name,
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS 'Size (MB)'
FROM information_schema.tables 
WHERE table_schema = 'virtuallab' 
AND table_name = 'email_verification_code';
```

## 安全测试

### 1. 验证码有效期测试

```javascript
// 测试过期验证码
setTimeout(async () => {
  await testVerifyEmailCode(); // 应该返回过期错误
}, 11 * 60 * 1000); // 11分钟后测试
```

### 2. 重复使用测试

```javascript
// 测试重复使用验证码
async function testReuseCode() {
  await testVerifyEmailCode(); // 第一次应该成功
  await testVerifyEmailCode(); // 第二次应该失败（已使用）
}
```

## 监控和日志

### 1. 应用日志

```bash
# 查看邮箱相关日志
grep "email" logs/application.log

# 查看验证码相关日志
grep "verification" logs/application.log
```

### 2. 数据库监控

```sql
-- 查看验证码统计
SELECT 
    type,
    COUNT(*) as total_count,
    SUM(CASE WHEN used = 1 THEN 1 ELSE 0 END) as used_count,
    SUM(CASE WHEN expire_time < NOW() THEN 1 ELSE 0 END) as expired_count
FROM email_verification_code 
GROUP BY type;
```

## 总结

通过以上测试步骤，您可以全面验证邮箱验证功能的正确性。如果遇到问题，请按照排查步骤逐一检查，确保：

1. ✅ 数据库表已正确创建
2. ✅ 邮箱配置正确
3. ✅ API接口正常响应
4. ✅ 验证码生成和验证逻辑正确
5. ✅ 过期清理机制正常工作 