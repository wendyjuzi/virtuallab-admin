# 虚拟仿真实训教学管理平台 - 权限管理系统

## 系统概述

本系统实现了基于RBAC（基于角色的访问控制）的多角色权限模型，支持细粒度权限控制和动态权限分配。

## 角色体系

### 1. 系统角色定义

- **系统管理员（SYSTEM_ADMIN）**：拥有系统所有权限，可以管理用户、角色、权限等
- **院系管理员（DEPARTMENT_ADMIN）**：管理本院系相关事务，包括实验管理、资源管理、成绩管理等
- **教师（TEACHER）**：管理课程和实验，可以创建实验项目、查看学生成绩等
- **学生（STUDENT）**：参与实验和学习，可以查看实验、提交报告等
- **访客（GUEST）**：只读权限，可以浏览公开内容

### 2. 权限级别

- 1级：系统管理员
- 2级：院系管理员
- 3级：教师
- 4级：学生
- 5级：访客

## 权限模型

### 1. 功能模块权限

- **实验管理（experiment）**：实验项目、实验记录、实验报告的管理
- **资源库（resource）**：教学资源的上传、下载、管理
- **成绩管理（score）**：学生成绩的录入、查看、统计
- **用户管理（user）**：用户信息的增删改查
- **系统管理（system）**：系统配置、日志查看等

### 2. 操作类型权限

- **创建（create）**：新增数据
- **查看（view）**：读取数据
- **编辑（edit）**：修改数据
- **删除（delete）**：删除数据
- **审批（approve）**：审批流程

### 3. 权限编码规则

权限编码格式：`模块:操作`，例如：
- `experiment:project:view` - 查看实验项目
- `resource:upload` - 上传资源
- `score:create` - 录入成绩

## 多因素认证

### 1. 支持的认证方式

- **密码认证**：传统用户名密码登录
- **短信验证码**：通过手机短信验证
- **邮箱验证码**：通过邮箱验证
- **指纹识别**：生物特征认证

### 2. 认证流程

1. 用户输入用户名和密码
2. 系统验证密码正确性
3. 如果启用了多因素认证，要求用户进行二次验证
4. 验证通过后完成登录

### 3. 配置多因素认证

```java
// 添加短信认证
AuthFactor smsFactor = new AuthFactor();
smsFactor.setUserId(userId);
smsFactor.setFactorType(AuthFactor.TYPE_SMS);
smsFactor.setFactorValue(phone);
authFactorService.addAuthFactor(smsFactor);

// 发送验证码
authFactorService.sendSmsCode(userId, phone);

// 验证验证码
boolean isValid = authFactorService.validateSmsCode(userId, phone, code);
```

## 动态权限分配

### 1. 临时权限

系统支持基于时间范围的临时权限分配，适用于：
- 课程安排
- 临时任务
- 特殊项目

### 2. 权限分配示例

```java
// 为学生分配临时教师权限
TempPermission tempPermission = new TempPermission();
tempPermission.setUserId(studentId);
tempPermission.setRoleId(teacherRoleId);
tempPermission.setStartTime(startTime);
tempPermission.setEndTime(endTime);
tempPermission.setReason("课程助教");
tempPermission.setGrantBy(adminId);
tempPermissionService.grantTempPermission(tempPermission);
```

### 3. 权限自动回收

系统会自动检查并回收过期的临时权限：
- 定时任务检查过期权限
- 自动更新权限状态
- 记录权限变更日志

## 使用指南

### 1. 权限注解使用

```java
@RestController
@RequestMapping("/experiment")
public class ExperimentController {
    
    @RequiresPermission("experiment:project:view")
    @GetMapping("/projects")
    public CommonResult<List<ExperimentProject>> getProjects() {
        // 只有拥有查看实验项目权限的用户才能访问
        return experimentService.getProjects();
    }
    
    @RequiresPermission("experiment:project:create")
    @PostMapping("/projects")
    public CommonResult<Boolean> createProject(@RequestBody ExperimentProject project) {
        // 只有拥有创建实验项目权限的用户才能访问
        return experimentService.createProject(project);
    }
    
    @RequiresRole("TEACHER")
    @GetMapping("/reports")
    public CommonResult<List<ExperimentReport>> getReports() {
        // 只有教师角色才能访问
        return experimentService.getReports();
    }
}
```

### 2. 权限检查工具

```java
@Autowired
private PermissionUtil permissionUtil;

// 检查用户是否有指定权限
boolean hasPermission = permissionUtil.hasPermission(userId, "experiment:project:view");

// 检查用户是否有指定角色
boolean hasRole = permissionUtil.hasRole(userId, "TEACHER");

// 检查用户是否是系统管理员
boolean isAdmin = permissionUtil.isSystemAdmin(userId);
```

### 3. 数据库初始化

执行 `src/main/resources/sql/init_auth_tables.sql` 脚本初始化数据库表结构和基础数据。

## API接口

### 1. 多因素认证接口

- `POST /auth/factor/sms/send` - 发送短信验证码
- `POST /auth/factor/sms/validate` - 验证短信验证码
- `POST /auth/factor/email/send` - 发送邮箱验证码
- `POST /auth/factor/email/validate` - 验证邮箱验证码
- `POST /auth/factor/fingerprint/validate` - 验证指纹

### 2. 临时权限管理接口

- `POST /auth/temp-permission/grant` - 分配临时权限
- `DELETE /auth/temp-permission/{id}` - 撤销临时权限
- `GET /auth/temp-permission/user/{userId}` - 查询用户临时权限
- `POST /auth/temp-permission/update-expired` - 更新过期权限

### 3. 权限检查接口

- `GET /auth/permission/check` - 检查用户权限
- `GET /auth/role/check` - 检查用户角色

## 安全建议

1. **密码安全**：使用强密码策略，定期更换密码
2. **多因素认证**：重要账户启用多因素认证
3. **权限最小化**：遵循最小权限原则
4. **定期审计**：定期检查用户权限分配
5. **日志记录**：记录所有权限相关操作

## 扩展功能

1. **权限组**：支持权限分组管理
2. **数据权限**：支持基于数据的权限控制
3. **API权限**：支持API级别的权限控制
4. **审计日志**：详细的权限操作审计
5. **权限模板**：预定义权限模板快速分配

## 系统架构

### 权限层级结构
```
系统管理员 (最高权限)
├── 院系管理员 (院系级权限)
    ├── 教师 (教学权限)
    ├── 学生 (学习权限)
    └── 访客 (只读权限)
```

### 核心组件
- **用户管理**: 账号全生命周期管理
- **角色管理**: 角色定义和权限分配
- **权限管理**: 细粒度权限控制
- **院系管理**: 组织架构管理
- **操作日志**: 审计追踪
- **权限模板**: 快速权限配置

## 功能模块

### 一、系统管理员权限管理能力

#### 1. 账号全生命周期管理

**账号创建**
- 支持创建所有角色账号（系统管理员、院系管理员、教师、学生、访客）
- 预设基础权限模板，如教师账号默认赋予实验管理、资源库查看与编辑等权限
- 批量创建用户账号功能

**账号信息修改**
- 修改任意账号的基本信息（姓名、联系方式等）
- 调整权限配置，适应工作调动或职责变更
- 确保权限与实际工作相匹配

**账号停用与删除**
- 停用长期不使用的账号或离职人员账号
- 彻底删除不再需要的账号，清除相关数据
- 释放系统资源

#### 2. 角色权限全局管理

**角色权限模板定义**
- 创建和维护各角色的权限模板
- 明确各角色在功能模块上的权限范围
- 支持权限继承和组合

**动态权限配置**
- 基于课程安排或临时任务，为特定角色或账号动态分配权限
- 支持跨院系合作项目的临时权限分配
- 项目结束后自动回收权限

**多因素认证管理**
- 配置和管理系统的多因素认证方式
- 调整认证策略（短信验证码有效期、密码复杂度等）
- 确保账号登录安全性

#### 3. 院系管理员管理

**院系管理员账号管理**
- 创建、修改、停用和删除院系管理员账号
- 根据院系规模和管理需求，合理分配院系管理员数量

**院系管理员权限分配**
- 为院系管理员分配管理本院系账号和资源的权限
- 根据实际情况调整权限范围
- 为重点院系管理员分配更多资源审批权限

#### 4. 系统监控与审计

**操作日志监控**
- 实时监控系统内所有账号的操作日志
- 记录登录时间、操作内容、访问的功能模块等
- 及时发现异常操作行为

**安全审计**
- 定期对系统权限分配和使用情况进行审计
- 检查权限滥用、越权操作等问题
- 生成审计报告，为权限优化提供依据

### 二、院系管理员权限管理能力

#### 1. 本院系账号管理

**账号创建与修改**
- 在本院系范围内，创建教师、学生和访客账号
- 修改本院系用户的基本信息和权限
- 为新入职教师创建账号，并根据教学任务分配相应权限

**账号状态管理**
- 对本院系账号进行停用和启用操作
- 当学生休学或教师请假时，及时停用账号
- 保障系统数据安全

#### 2. 本院系权限管理

**角色权限微调**
- 在系统管理员设定的角色权限模板基础上，对本院系用户权限进行微调
- 根据课程特色，为本院系特定课程的教师赋予更多权限

**动态权限调整**
- 针对本院系的课程安排和临时任务，为教师和学生动态分配权限
- 在组织本院系实训竞赛时，为参赛学生临时开放竞赛相关权限
- 竞赛结束后自动回收权限

#### 3. 教学资源与数据管理

**资源库管理**
- 管理本院系在资源库中的教学资源
- 上传、编辑、删除本院系资源
- 审核本院系教师提交的资源，确保资源质量和合规性

**成绩管理**
- 对本院系学生的成绩数据进行管理
- 查看、编辑（在规定权限内）、审批成绩
- 生成成绩报表，为教学评估提供数据支持

#### 4. 与系统管理员协同

**权限申请与反馈**
- 当院系有特殊权限需求时，向系统管理员提交权限申请
- 及时反馈权限使用过程中出现的问题
- 协助系统管理员优化权限管理策略

**账号异常处理**
- 对于本院系账号出现的异常登录、权限异常等问题，及时上报系统管理员
- 配合进行调查和处理

## API接口说明

### 系统管理员接口

#### 用户管理接口
```
POST /api/system-admin/users                    # 创建用户账号
POST /api/system-admin/users/batch              # 批量创建用户账号
PUT /api/system-admin/users                     # 修改用户信息
POST /api/system-admin/users/{userId}/disable   # 停用用户账号
POST /api/system-admin/users/{userId}/enable    # 启用用户账号
DELETE /api/system-admin/users/{userId}         # 删除用户账号
POST /api/system-admin/users/{userId}/reset-password  # 重置用户密码
POST /api/system-admin/users/{userId}/lock      # 锁定用户账号
POST /api/system-admin/users/{userId}/unlock    # 解锁用户账号
```

#### 角色权限管理接口
```
POST /api/system-admin/roles                    # 创建角色
PUT /api/system-admin/roles                     # 更新角色
DELETE /api/system-admin/roles/{roleId}         # 删除角色
POST /api/system-admin/roles/{roleId}/permissions  # 为角色分配权限
POST /api/system-admin/users/{userId}/roles     # 为用户分配角色
POST /api/system-admin/users/{userId}/temporary-permissions  # 设置临时权限
```

#### 院系管理接口
```
POST /api/system-admin/departments              # 创建院系
PUT /api/system-admin/departments               # 更新院系信息
DELETE /api/system-admin/departments/{departmentId}  # 删除院系
GET /api/system-admin/departments               # 获取院系列表
```

#### 系统监控接口
```
GET /api/system-admin/operation-logs            # 获取操作日志
GET /api/system-admin/operation-logs/export     # 导出操作日志
GET /api/system-admin/statistics/user-login     # 获取用户登录统计
GET /api/system-admin/statistics/permission-usage  # 获取权限使用统计
GET /api/system-admin/audit-report              # 生成安全审计报告
```

### 院系管理员接口

#### 本院系用户管理接口
```
POST /api/department-admin/users                # 创建本院系用户账号
POST /api/department-admin/users/batch          # 批量创建本院系用户账号
PUT /api/department-admin/users                 # 修改本院系用户信息
POST /api/department-admin/users/{userId}/disable  # 停用本院系用户账号
POST /api/department-admin/users/{userId}/enable   # 启用本院系用户账号
POST /api/department-admin/users/{userId}/reset-password  # 重置本院系用户密码
```

#### 本院系权限管理接口
```
POST /api/department-admin/users/{userId}/roles  # 为本院系用户分配角色
POST /api/department-admin/users/{userId}/temporary-permissions  # 为本院系用户设置临时权限
POST /api/department-admin/users/{userId}/permissions/adjust  # 调整本院系用户权限
```

#### 教学资源管理接口
```
POST /api/department-admin/resources/{resourceId}  # 管理本院系教学资源
POST /api/department-admin/resources/{resourceId}/approve  # 审核本院系教师提交的资源
POST /api/department-admin/scores/{scoreId}       # 管理本院系学生成绩数据
GET /api/department-admin/scores/report           # 生成本院系成绩报表
```

#### 协同管理接口
```
POST /api/department-admin/permission-requests   # 提交权限申请
POST /api/department-admin/user-abnormal         # 上报账号异常
GET /api/department-admin/permission-requests/status  # 获取权限申请状态
```

## 数据库设计

### 核心表结构

1. **department** - 院系表
2. **role** - 角色表
3. **permission** - 权限表
4. **user_role** - 用户角色关联表（扩展）
5. **role_permission** - 角色权限关联表
6. **operation_log** - 操作日志表
7. **permission_template** - 权限模板表
8. **permission_request** - 权限申请表

### 权限编码规范

权限编码采用 `模块:操作` 的格式：
- `user:view` - 用户查看权限
- `user:create` - 用户创建权限
- `experiment:edit` - 实验编辑权限
- `resource:approve` - 资源审批权限

## 使用示例

### 1. 创建院系管理员

```bash
curl -X POST "http://localhost:8080/api/system-admin/users" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "dept_admin",
    "password": "123456",
    "realName": "张主任",
    "email": "zhang@example.com",
    "department": "计算机学院",
    "roleIds": [2],
    "departmentId": 1,
    "userType": "DEPARTMENT_ADMIN",
    "reason": "新任院系管理员"
  }'
```

### 2. 为教师分配权限

```bash
curl -X POST "http://localhost:8080/api/department-admin/users/3/roles" \
  -H "Content-Type: application/json" \
  -d '[3]' \
  -G -d "adminUserId=2"
```

### 3. 设置临时权限

```bash
curl -X POST "http://localhost:8080/api/system-admin/users/5/temporary-permissions" \
  -G -d "roleId=3" \
  -d "startTime=2024-01-01 00:00:00" \
  -d "endTime=2024-06-30 23:59:59" \
  -d "reason=临时项目需要"
```

## 安全考虑

1. **权限最小化原则**: 用户只拥有完成工作所需的最小权限
2. **权限分离**: 敏感操作需要多人协作完成
3. **审计追踪**: 所有权限操作都有详细日志记录
4. **定期审查**: 定期审查权限分配，及时回收不必要的权限
5. **临时权限**: 临时权限自动过期，避免权限泄露

## 最佳实践

1. **角色设计**: 根据实际业务需求设计角色，避免角色过多或过少
2. **权限模板**: 使用权限模板快速配置常用权限组合
3. **定期维护**: 定期清理无效用户和权限
4. **培训教育**: 对管理员进行权限管理培训
5. **应急预案**: 制定权限管理应急预案，确保系统安全

## 常见问题

### Q: 如何快速为多个用户分配相同权限？
A: 使用权限模板功能，创建包含所需权限的模板，然后批量应用到用户。

### Q: 如何处理用户离职？
A: 立即停用用户账号，并在确认无遗留问题后删除账号。

### Q: 如何监控权限使用情况？
A: 通过操作日志和权限使用统计功能，定期查看权限使用情况。

### Q: 临时权限过期后如何处理？
A: 系统会自动回收过期权限，管理员也可以手动提前回收。

## 技术支持

如有问题，请联系系统管理员或查看系统日志获取详细信息。 